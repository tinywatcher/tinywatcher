# TinyWatcher Stream Configuration Example
# This shows how to monitor logs from various streaming sources

inputs:
  # Traditional file-based logs
  files:
    - /var/log/app/error.log
  
  # Docker container logs
  containers:
    - my-app-container
  
  # Stream-based log sources (NEW!)
  streams:
    # Azure App Service log streaming
    - name: azure_app_service
      type: websocket
      url: "wss://myapp.scm.azurewebsites.net/api/logstream/application"
      headers:
        Authorization: "Bearer YOUR_TOKEN_HERE"
      reconnect_delay: 5  # seconds

    # AWS CloudWatch Logs via HTTP streaming endpoint
    - name: cloudwatch_stream
      type: http
      url: "https://logs.us-east-1.amazonaws.com/stream"
      headers:
        X-Amz-Target: "Logs_20140328.GetLogEvents"
        Content-Type: "application/x-amz-json-1.1"
      reconnect_delay: 10

    # Custom TCP log aggregator
    - name: syslog_tcp
      type: tcp
      url: "localhost:514"
      reconnect_delay: 3

    # Kubernetes pod logs via WebSocket
    - name: k8s_pod_logs
      type: websocket
      url: "wss://k8s-api-server:443/api/v1/namespaces/default/pods/my-pod/log"
      headers:
        Authorization: "Bearer YOUR_K8S_TOKEN"

    # Custom HTTP streaming endpoint (SSE)
    - name: custom_http_stream
      type: http
      url: "https://my-log-service.com/stream"
      headers:
        Accept: "text/event-stream"
        Api-Key: "your-api-key"

# Alert configurations
alerts:
  stdout:
    type: stdout

  slack_critical:
    type: slack
    url: "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"

  webhook_alerts:
    type: webhook
    url: "https://your-webhook-endpoint.com/alerts"

  email_team:
    type: email
    from: "alerts@mycompany.com"
    to:
      - "devops@mycompany.com"
      - "oncall@mycompany.com"
    smtp_server: "smtp.gmail.com:587"  # Optional on non-Unix systems

# Rules that apply to ALL sources (files, containers, streams)
rules:
  - name: error_detection
    pattern: "(ERROR|FATAL|Exception)"
    alert: 
      - stdout
      - slack_critical
    cooldown: 60

  - name: authentication_failure
    pattern: "(authentication failed|invalid credentials|unauthorized)"
    alert: email_team
    cooldown: 300

  - name: http_5xx
    pattern: "HTTP/[0-9.]+ 5[0-9]{2}"
    alert: 
      - stdout
      - webhook_alerts
    cooldown: 120

  - name: database_connection_error
    pattern: "(connection timeout|database unavailable|connection refused.*:3306)"
    alert:
      - slack_critical
      - email_team
    cooldown: 180

  - name: memory_leak_indicator
    pattern: "(OutOfMemoryError|heap space|memory exhausted)"
    alert:
      - email_team
      - slack_critical
    cooldown: 600

# Resource monitoring (optional)
resources:
  interval: 30
  thresholds:
    cpu_percent: 80
    memory_percent: 85
    disk_percent: 90
    alert: slack_critical
